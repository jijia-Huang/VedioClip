# 影片剪輯工具 - 技術方案

## 專案架構

### 技術棧選擇

#### 前端框架
- **Electron** (已確認)
- **React** + **TypeScript** (推薦，提供良好的型別檢查和元件化開發)
- **CSS Framework**: Tailwind CSS 或 styled-components (現代化 UI)

#### 影片處理
- **FFmpeg** (已確認)
- **fluent-ffmpeg** (Node.js 封裝，提供友善的 API)
- **ffprobe** (用於取得影片資訊)

#### 狀態管理
- **Zustand** 或 **Jotai** (輕量級狀態管理，適合 Electron 應用)

#### UI 元件庫
- **Radix UI** 或 **Headless UI** (無樣式元件，可自訂樣式)
- 或使用 **Ant Design** / **Material-UI** (完整元件庫)

---

## 專案結構

```
VedioClip/
├── package.json
├── electron-builder.json
├── tsconfig.json
├── src/
│   ├── main/                    # Electron 主進程
│   │   ├── main.ts              # 主進程入口
│   │   ├── video-processor.ts   # FFmpeg 影片處理邏輯
│   │   └── ipc-handlers.ts      # IPC 通訊處理
│   ├── renderer/                # Electron 渲染進程 (React)
│   │   ├── index.html
│   │   ├── main.tsx             # React 入口
│   │   ├── App.tsx
│   │   ├── components/
│   │   │   ├── VideoPlayer/     # 影片預覽元件
│   │   │   ├── Timeline/        # 時間軸元件
│   │   │   ├── ClipList/        # 剪輯片段列表
│   │   │   ├── ClipEditor/      # 片段編輯表單
│   │   │   └── ExportPanel/     # 輸出設定面板
│   │   ├── stores/              # 狀態管理
│   │   │   ├── videoStore.ts    # 影片狀態
│   │   │   └── clipStore.ts     # 剪輯片段狀態
│   │   └── utils/
│   │       ├── timeFormat.ts    # 時間格式化工具
│   │       └── fileUtils.ts     # 檔案處理工具
│   └── shared/                  # 共享型別定義
│       └── types.ts
└── dist/                        # 建置輸出
```

---

## 核心功能實作方案

### 1. 影片載入功能

#### 主進程 (video-processor.ts)
```typescript
// 使用 ffprobe 取得影片資訊
import ffmpeg from 'fluent-ffmpeg';
import { promisify } from 'util';

interface VideoInfo {
  duration: number;      // 秒數
  width: number;
  height: number;
  format: string;
  bitrate: number;
}

async function getVideoInfo(videoPath: string): Promise<VideoInfo> {
  return new Promise((resolve, reject) => {
    ffmpeg.ffprobe(videoPath, (err, metadata) => {
      if (err) reject(err);
      else {
        resolve({
          duration: metadata.format.duration || 0,
          width: metadata.streams[0]?.width || 0,
          height: metadata.streams[0]?.height || 0,
          format: metadata.format.format_name || '',
          bitrate: metadata.format.bit_rate || 0,
        });
      }
    });
  });
}
```

#### IPC 通訊
- `video:load` - 載入影片檔案
- `video:get-info` - 取得影片資訊

---

### 2. 多段剪輯功能

#### 資料結構
```typescript
interface ClipSegment {
  id: string;           // 唯一識別碼
  name: string;        // 片段名稱
  startTime: number;   // 開始時間（秒）
  endTime: number;     // 結束時間（秒）
}

// 狀態管理 (clipStore.ts)
interface ClipStore {
  segments: ClipSegment[];
  addSegment: (segment: Omit<ClipSegment, 'id'>) => void;
  updateSegment: (id: string, updates: Partial<ClipSegment>) => void;
  deleteSegment: (id: string) => void;
}
```

#### 驗證邏輯
- 開始時間 < 結束時間
- 時間範圍在影片長度內
- 片段名稱不能重複（可選）

---

### 3. 時間軸介面

#### Timeline 元件設計
```typescript
interface TimelineProps {
  duration: number;              // 影片總長度
  currentTime: number;          // 當前播放時間
  segments: ClipSegment[];      // 所有片段
  onTimeChange: (time: number) => void;
  onSeek: (time: number) => void;
}
```

#### 視覺化方案
- 使用 Canvas 或 SVG 繪製時間軸
- 顯示時間刻度（每 10 秒一個標記）
- 用不同顏色區分不同片段
- 顯示當前播放位置指標
- 點擊時間軸可跳轉到對應位置

#### 時間輸入格式
- 支援多種格式：`秒數`、`分:秒`、`時:分:秒`
- 統一轉換為秒數儲存
- 顯示時格式化為 `分:秒` 或 `時:分:秒`

---

### 4. 影片預覽功能

#### VideoPlayer 元件
- 使用 HTML5 `<video>` 元素
- 支援播放/暫停
- 顯示當前時間和總時長
- 支援跳轉到指定時間
- 可選：顯示縮圖預覽

---

### 5. 批次輸出功能

#### 主進程處理 (video-processor.ts)
```typescript
interface ExportOptions {
  outputFormat: 'mp4' | 'avi' | 'mov';
  quality: 'high' | 'medium' | 'low';
  outputDir: string;
}

async function exportClip(
  videoPath: string,
  segment: ClipSegment,
  options: ExportOptions
): Promise<string> {
  const outputPath = path.join(
    options.outputDir,
    `${sanitizeFileName(segment.name)}.${options.outputFormat}`
  );

  return new Promise((resolve, reject) => {
    ffmpeg(videoPath)
      .setStartTime(segment.startTime)
      .setDuration(segment.endTime - segment.startTime)
      .outputOptions(getQualityOptions(options.quality))
      .output(outputPath)
      .on('end', () => resolve(outputPath))
      .on('error', reject)
      .on('progress', (progress) => {
        // 透過 IPC 發送進度更新
        mainWindow.webContents.send('export:progress', {
          segmentId: segment.id,
          percent: progress.percent || 0,
        });
      })
      .run();
  });
}

async function exportAllClips(
  videoPath: string,
  segments: ClipSegment[],
  options: ExportOptions
): Promise<void> {
  for (const segment of segments) {
    await exportClip(videoPath, segment, options);
  }
}
```

#### IPC 通訊
- `export:start` - 開始批次輸出
- `export:progress` - 輸出進度更新
- `export:complete` - 輸出完成
- `export:error` - 輸出錯誤

---

## UI/UX 設計

### 版面配置
```
┌─────────────────────────────────────────┐
│  標題列 (載入影片按鈕)                    │
├─────────────────────────────────────────┤
│                                         │
│  影片預覽視窗                            │
│  [播放控制] [時間顯示]                    │
│                                         │
├─────────────────────────────────────────┤
│  時間軸 (可視化顯示，點擊跳轉)            │
├─────────────────────────────────────────┤
│  剪輯片段列表                            │
│  ┌───────────────────────────────────┐ │
│  │ 名稱    │ 開始時間 │ 結束時間 │ 操作 │ │
│  │ 開場    │ 00:01    │ 00:10    │ [編輯][刪除] │
│  │ 精彩片段│ 00:15    │ 00:30    │ [編輯][刪除] │
│  └───────────────────────────────────┘ │
│  [新增片段]                              │
├─────────────────────────────────────────┤
│  輸出設定                                │
│  格式: [MP4 ▼] 品質: [高品質 ▼]         │
│  輸出位置: [選擇資料夾]                   │
│  [開始輸出]                              │
└─────────────────────────────────────────┘
```

### 片段編輯表單
- 名稱輸入框
- 開始時間輸入框（支援多種格式）
- 結束時間輸入框（支援多種格式）
- 驗證提示
- 儲存/取消按鈕

---

## 技術實作細節

### 1. Electron 主進程設定

#### main.ts
```typescript
import { app, BrowserWindow, ipcMain, dialog } from 'electron';
import path from 'path';

let mainWindow: BrowserWindow | null = null;

function createWindow() {
  mainWindow = new BrowserWindow({
    width: 1200,
    height: 800,
    webPreferences: {
      nodeIntegration: false,
      contextIsolation: true,
      preload: path.join(__dirname, 'preload.js'),
    },
  });

  mainWindow.loadFile('dist/index.html');
}

// IPC 處理器註冊
ipcMain.handle('video:load', async () => {
  const result = await dialog.showOpenDialog({
    properties: ['openFile'],
    filters: [
      { name: '影片', extensions: ['mp4', 'avi', 'mov', 'mkv'] },
    ],
  });
  return result.filePaths[0];
});
```

### 2. IPC 通訊層

#### preload.js (安全橋接)
```javascript
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('electronAPI', {
  loadVideo: () => ipcRenderer.invoke('video:load'),
  getVideoInfo: (path) => ipcRenderer.invoke('video:get-info', path),
  exportClips: (segments, options) => 
    ipcRenderer.invoke('export:start', segments, options),
  onExportProgress: (callback) => 
    ipcRenderer.on('export:progress', callback),
});
```

### 3. 時間格式化工具

#### timeFormat.ts
```typescript
// 將秒數轉換為 時:分:秒 格式
export function formatTime(seconds: number): string {
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);
  
  if (hours > 0) {
    return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
  }
  return `${minutes}:${String(secs).padStart(2, '0')}`;
}

// 解析時間字串為秒數
export function parseTime(timeString: string): number {
  // 支援格式: "10", "1:10", "1:10:30"
  const parts = timeString.split(':').map(Number);
  
  if (parts.length === 1) return parts[0];
  if (parts.length === 2) return parts[0] * 60 + parts[1];
  if (parts.length === 3) return parts[0] * 3600 + parts[1] * 60 + parts[2];
  
  throw new Error('Invalid time format');
}
```

### 4. 檔案名稱清理

```typescript
export function sanitizeFileName(fileName: string): string {
  // 移除或替換不合法的檔案名稱字元
  return fileName
    .replace(/[<>:"/\\|?*]/g, '_')
    .replace(/\s+/g, '_')
    .trim();
}
```

---

## 依賴套件

### package.json 核心依賴
```json
{
  "dependencies": {
    "electron": "^28.0.0",
    "fluent-ffmpeg": "^2.1.2",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "zustand": "^4.4.0",
    "tailwindcss": "^3.3.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@types/react": "^18.2.0",
    "@types/fluent-ffmpeg": "^2.1.21",
    "typescript": "^5.2.0",
    "vite": "^5.0.0",
    "electron-builder": "^24.6.0"
  }
}
```

---

## 開發流程

### 階段一：專案初始化
1. 建立 Electron + React + TypeScript 專案結構
2. 設定建置工具 (Vite + electron-builder)
3. 安裝核心依賴
4. 設定 FFmpeg 路徑

### 階段二：核心功能開發
1. 影片載入與資訊顯示
2. 時間軸元件開發
3. 片段管理功能（新增、編輯、刪除）
4. 影片預覽功能

### 階段三：輸出功能
1. FFmpeg 整合
2. 單片段輸出測試
3. 批次輸出功能
4. 進度顯示

### 階段四：UI/UX 優化
1. 介面美化
2. 錯誤處理
3. 使用者提示
4. 效能優化

---

## 注意事項

### FFmpeg 安裝
- Windows: 需要下載 FFmpeg 並設定環境變數，或將 FFmpeg 打包到應用程式中
- 建議使用 `@ffmpeg-installer/ffmpeg` 自動下載

### 效能考量
- 大型影片檔案處理時，使用 Worker 執行緒避免 UI 凍結
- 批次輸出時，可考慮並行處理（但需注意系統資源）

### 錯誤處理
- 影片格式不支援
- FFmpeg 執行失敗
- 檔案路徑錯誤
- 時間範圍無效

### 安全性
- 使用 `contextIsolation: true` 和 `preload` 腳本
- 驗證所有使用者輸入
- 檔案路徑清理

---

## 後續擴充功能（可選）

1. **預覽縮圖**：在時間軸上顯示關鍵幀縮圖
2. **音訊處理**：音量調整、音訊分離
3. **批次命名規則**：支援模板變數（如 `{name}_{index}.mp4`）
4. **匯出設定儲存**：記住使用者的輸出偏好
5. **多檔案處理**：一次處理多個影片檔案

---

**方案狀態**：待審核確認
**建立時間**：2024
